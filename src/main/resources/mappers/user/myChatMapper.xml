<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moira.itda.domain.user.mychat.mapper.MyChatMapper">
    <!-- 마이페이지 > 내 거래 목록 > 채팅 > 채팅 목록 조회 > totalElements 계산 -->
    <select id="selectChatRoomListCnt">
        SELECT COUNT(id) FROM CHAT_ROOM WHERE seller_id = #{userId} OR buyer_id = #{userId}
    </select>

    <!-- 마이페이지 > 내 거래 목록 > 채팅 > 채팅 목록 조회 -->
    <select id="selectChatRoomList" resultType="com.moira.itda.domain.user.mychat.dto.response.MyChatResponse">
        WITH MY_CHAT_ROOM AS (
            SELECT
                   id
                 , trade_id
                 , seller_id
                 , buyer_id
                 , status
                 , created_at
            FROM CHAT_ROOM
            WHERE seller_id = #{userId} OR buyer_id = #{userId}
        ),
        LAST_MESSAGE AS (
            SELECT
                   chat_room_id
                 , message
                 , created_at
                 , RANK() OVER (ORDER BY created_at DESC) AS rn
            FROM CHAT_MESSAGE
            WHERE chat_room_id IN (SELECT id FROM MY_CHAT_ROOM)
        )
        SELECT
               CR.id AS chatRoomId
             , CR.seller_id
             , U_S.nickname  AS sellerNickname
             , CR.buyer_id
             , U_B.nickname  AS buyerNickname
             , CR.status
             , CR.created_at
             , LM.message    AS lastMessage
             , LM.created_at AS lastMessageAt
             , T.id
             , T.type
             , T.title
        FROM MY_CHAT_ROOM CR
         INNER JOIN USER U_S ON U_S.id = CR.seller_id
         INNER JOIN USER U_B ON U_B.id = CR.buyer_id
         LEFT JOIN LAST_MESSAGE LM ON LM.chat_room_id = CR.id AND LM.rn = 1
         INNER JOIN TRADE T ON T.id = CR.trade_id
        ORDER BY lastMessageAt DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 마이페이지 > 내 거래 목록 > 채팅 > 채팅 목록 조회 > 채팅방 > 거래 제안 정보 조회 -->
    <select id="getTradeSuggest" resultType="com.moira.itda.domain.user.mychat.dto.response.TradeSuggestResponse">

    </select>

    <!-- 마이페이지 > 내 거래 목록 > 채팅 > 채팅 목록 조회 > 채팅방 > 이전 채팅 목록 조회 -->
    <select id="selectChatMessageList" resultType="com.moira.itda.domain.user.mychat.dto.response.ChatMessageResponse">
        SELECT
               CM.id      AS chatMessageId
             , CM.sender_id
             , U.nickname AS senderNickname
             , CM.message
             , CM.created_at
        FROM CHAT_MESSAGE CM
         LEFT JOIN USER U ON U.id = CM.sender_id
        WHERE CM.chat_room_id = #{chatRoomId}
        ORDER BY CM.created_at ASC
    </select>

    <!-- 마이페이지 > 내 거래 목록 > 채팅 > 채팅 목록 조회 > 채팅방 > 메시지 전송 > ChatMessage 저장 -->
    <insert id="insertChatMessage">
        INSERT INTO CHAT_MESSAGE (
               chat_room_id
             , sender_id
             , message
             , created_at
        )
        VALUES (
               #{chatRoomId}
             , #{senderId}
             , #{message}
             , #{createdAt}
        )
    </insert>
</mapper>