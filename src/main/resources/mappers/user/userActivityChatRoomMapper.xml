<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moira.itda.domain.user_activity_chat.mapper.UserActivityChatRoomMapper">
    <!-- 채팅방 목록 조회 > totalElements 계산 -->
    <select id="selectChatRoomListCnt">
        SELECT COUNT(id) FROM CHAT_ROOM WHERE seller_id = #{userId} OR buyer_id = #{userId}
    </select>

    <!-- 채팅방 목록 조회 -->
    <select id="selectChatRoomList" resultType="com.moira.itda.domain.user_activity_chat.dto.response.ChatRoomResponse">
        WITH MY_CHAT_ROOM AS (
            SELECT
                   id
                 , trade_id
                 , trade_item_id
                 , seller_id
                 , buyer_id
                 , status
                 , created_at
            FROM CHAT_ROOM
            WHERE seller_id = #{userId} OR buyer_id = #{userId}
        ),
        LAST_MESSAGE AS (
            SELECT
                   chat_room_id
                 , message
                 , created_at
                 , RANK() OVER (ORDER BY created_at DESC) AS rn
            FROM CHAT_MESSAGE
            WHERE chat_room_id IN (SELECT id FROM MY_CHAT_ROOM)
        )
        SELECT
               CR.id AS chatRoomId
             , CR.seller_id
             , U_S.nickname  AS sellerNickname
             , CR.buyer_id
             , U_B.nickname  AS buyerNickname
             , CR.status
             , CR.created_at
             , LM.message    AS lastMessage
             , LM.created_at AS lastMessageAt
             , T.id
             , CR.trade_item_id
             , T.type
             , T.title
             , T.file_id
             , F.file_url
        FROM MY_CHAT_ROOM CR
         INNER JOIN USER         U_S ON U_S.id          = CR.seller_id
         INNER JOIN USER         U_B ON U_B.id          = CR.buyer_id
         LEFT JOIN  LAST_MESSAGE LM  ON LM.chat_room_id = CR.id AND LM.rn = 1
         INNER JOIN TRADE        T   ON T.id            = CR.trade_id
         LEFT JOIN  IMAGE_FILE   F   ON F.file_id       = T.file_id
        ORDER BY CR.status = 'ACTIVE' DESC, lastMessageAt DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
</mapper>