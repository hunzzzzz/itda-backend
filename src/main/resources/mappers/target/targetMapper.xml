<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moira.itda.domain.target.mapper.TargetMapper">
    <!-- 교환 및 판매 대상 지정 모달 > 즐겨찾기 목록 > 가챠 목록 조회 > totalElements 계산 -->
    <select id="selectGachaWishCnt">
        SELECT COUNT(id) FROM GACHA_WISH WHERE user_id = #{userId}
    </select>

    <!-- 교환 및 판매 대상 지정 모달 > 즐겨찾기 목록 > 가챠 목록 조회 -->
    <select id="selectGachaWishList" resultType="com.moira.itda.domain.target.dto.response.TargetGachaResponse">
        SELECT G.id AS gachaId, G.title
        FROM GACHA_WISH GW
        LEFT JOIN GACHA G
         ON G.id = GW.gacha_id
        WHERE GW.user_id = #{userId}
        ORDER BY GW.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 교환 및 판매 대상 지정 모달 > 즐겨찾기 목록 > 하위 아이템 목록 조회 -->
    <!-- 교환 및 판매 대상 지정 모달 > 가챠 목록 > 하위 아이템 목록 조회 -->
    <select id="selectGachaItemList" resultType="com.moira.itda.domain.target.dto.response.TargetGachaItemResponse">
        SELECT id AS gachaItemId, name FROM GACHA_ITEM WHERE gacha_id = #{gachaId}
    </select>

    <!-- 교환 및 판매 대상 지정 모달 > 가챠 목록 > totalElements 계산 -->
    <select id="selectGachaCnt">
        SELECT COUNT(id)
        FROM GACHA
        WHERE 1=1
        <choose>
            <when test="keywordPattern != null and keywordPattern != ''">
                AND (
                     title        LIKE #{keywordPattern}
                  OR manufacturer LIKE #{keywordPattern}
                )
            </when>
        </choose>
    </select>

    <!-- 교환 및 판매 대상 지정 모달 > 가챠 목록 > 가챠시리즈 목록 조회 -->
    <select id="selectGachaList" resultType="com.moira.itda.domain.target.dto.response.TargetGachaResponse">
        SELECT id AS gachaId, title
        FROM GACHA
        WHERE 1=1
        <choose>
            <when test="keywordPattern != null and keywordPattern != ''">
                AND (
                     title        LIKE #{keywordPattern}
                  OR manufacturer LIKE #{keywordPattern}
                )
            </when>
        </choose>
        ORDER BY created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
</mapper>