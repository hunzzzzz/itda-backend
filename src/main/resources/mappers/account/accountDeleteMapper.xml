<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moira.itda.domain.account.delete.mapper.AccountDeleteMapper">
    <!-- 회원탈퇴 > User status 변경 (DELETED) -->
    <update id="updateUserStatusDeleted">
        UPDATE USER
        SET
               status     = 'DELETED'
             , nickname   = '탈퇴한 유저'
             , updated_at = CURRENT_TIMESTAMP
        WHERE id = #{userId}
    </update>

    <!-- 회윈털퇴 > PENDING인 Trade 존재 여부 확인 -->
    <select id="selectPendingTradeChk" resultType="java.lang.Boolean">
        SELECT EXISTS (
            SELECT 1 FROM TRADE
            WHERE user_id = #{userId} AND status = 'PENDING'
        )
    </select>

    <!-- 회원탈퇴 > PENDING인 TradeSuggest 존재 여부 확인 -->
    <select id="selectPendingTradeSuggestChk" resultType="java.lang.Boolean">
        SELECT EXISTS (
            SELECT 1 FROM TRADE_SUGGEST
            WHERE user_id = #{userId} AND status = 'PENDING'
        )
    </select>

    <!-- 회원탈퇴 > ACTIVE인 ChatRoom 존재 여부 확인 -->
    <select id="selectActiveChatRoomChk" resultType="java.lang.Boolean">
        SELECT EXISTS (
            SELECT 1 FROM CHAT_ROOM
            WHERE (seller_id = #{userId} OR buyer_id = #{userId})
             AND  status = 'ACTIVE'
        )
    </select>
</mapper>