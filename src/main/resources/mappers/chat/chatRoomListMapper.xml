<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moira.itda.domain.chat.list.mapper.ChatRoomListMapper">
    <!-- 채팅방 목록 조회 > totalElements 계산 -->
    <select id="selectChatRoomListCnt">
        SELECT COUNT(id) FROM CHAT_ROOM WHERE seller_id = #{userId} OR buyer_id = #{userId}
    </select>

    <!-- 채팅방 목록 조회 -->
    <select id="selectChatRoomList" resultType="com.moira.itda.domain.chat.list.dto.response.ChatRoomResponse">
        WITH MY_CHAT_ROOM AS (
            SELECT
                   id
                 , trade_id
                 , trade_item_id
                 , trade_suggest_id
                 , CASE WHEN seller_id = #{userId}
                        THEN buyer_id
                        ELSE seller_id
                   END AS opponent_id
                 , status
                 , created_at
            FROM CHAT_ROOM
            WHERE seller_id = #{userId} OR buyer_id = #{userId}
        ),
        LAST_MESSAGE AS (
            SELECT
                   chat_room_id
                 , message
                 , created_at
                 , RANK() OVER (PARTITION BY chat_room_id ORDER BY created_at DESC) AS rn
            FROM CHAT_MESSAGE
            WHERE chat_room_id IN (SELECT id FROM MY_CHAT_ROOM)
        )
        SELECT
               CR.id AS chatRoomId
             , CR.opponent_id
             , U.nickname                     AS opponent_nickname
             , CR.status
             , CR.created_at
             , LM.message                     AS last_message
             , LM.created_at                  AS last_message_at
             , T.id
             , CR.trade_item_id
             , T.type
             , T.title
             , TS.id                          AS trade_suggest_id
             , TS.purchase_item_id            AS trade_purchase_item_id
             , GI_1.name                      AS trade_purchase_item_name
             , CASE WHEN TS.purchase_discount_yn = 'Y'
                    THEN TS.purchase_discount_price
                    ELSE TS.purchase_original_price
               END                            AS trade_purchase_price
             , TS.exchange_seller_item_id     AS trade_exchange_seller_item_id
             , GI_2.name                      AS trade_exchange_seller_item_name
             , TS.exchange_suggested_item_id  AS trade_exchange_suggested_item_id
             , GI_3.name                      AS trade_exchange_suggested_item_name
             , T.file_id
             , F.file_url
        FROM MY_CHAT_ROOM CR
         INNER JOIN USER          U    ON U.id            = CR.opponent_id
         LEFT JOIN  LAST_MESSAGE  LM   ON LM.chat_room_id = CR.id AND LM.rn = 1
         INNER JOIN TRADE         T    ON T.id            = CR.trade_id
         INNER JOIN TRADE_SUGGEST TS   ON TS.id           = CR.trade_suggest_id
         LEFT JOIN  GACHA_ITEM    GI_1 ON GI_1.id         = TS.purchase_item_id
         LEFT JOIN  GACHA_ITEM    GI_2 ON GI_2.id         = TS.exchange_seller_item_id
         LEFT JOIN  GACHA_ITEM    GI_3 ON GI_3.id         = TS.exchange_suggested_item_id
         LEFT JOIN  IMAGE_FILE    F    ON F.file_id       = T.file_id
        ORDER BY CR.status = 'ACTIVE' DESC, last_message_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
</mapper>