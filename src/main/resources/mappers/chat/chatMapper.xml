<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moira.itda.domain.chat.mapper.ChatMapper">
    <!-- 내 활동 > 채팅 > 채팅방 목록 조회 > totalElements 계산 -->
    <select id="selectChatRoomListCnt">
        SELECT COUNT(id) FROM CHAT_ROOM WHERE seller_id = #{userId} OR buyer_id = #{userId}
    </select>

    <!-- 내 활동 > 채팅 > 채팅방 목록 조회 -->
    <select id="selectChatRoomList" resultType="com.moira.itda.domain.chat.dto.response.MyChatResponse">
        WITH MY_CHAT_ROOM AS (
            SELECT
                   id
                 , trade_id
                 , trade_item_id
                 , seller_id
                 , buyer_id
                 , status
                 , created_at
            FROM CHAT_ROOM
            WHERE seller_id = #{userId} OR buyer_id = #{userId}
        ),
        LAST_MESSAGE AS (
            SELECT
                   chat_room_id
                 , message
                 , created_at
                 , RANK() OVER (ORDER BY created_at DESC) AS rn
            FROM CHAT_MESSAGE
            WHERE chat_room_id IN (SELECT id FROM MY_CHAT_ROOM)
        )
        SELECT
               CR.id AS chatRoomId
             , CR.seller_id
             , U_S.nickname  AS sellerNickname
             , CR.buyer_id
             , U_B.nickname  AS buyerNickname
             , CR.status
             , CR.created_at
             , LM.message    AS lastMessage
             , LM.created_at AS lastMessageAt
             , T.id
             , CR.trade_item_id
             , T.type
             , T.title
        FROM MY_CHAT_ROOM CR
         INNER JOIN USER U_S ON U_S.id = CR.seller_id
         INNER JOIN USER U_B ON U_B.id = CR.buyer_id
         LEFT JOIN LAST_MESSAGE LM ON LM.chat_room_id = CR.id AND LM.rn = 1
         INNER JOIN TRADE T ON T.id = CR.trade_id
        ORDER BY CR.status = 'ACTIVE' DESC, lastMessageAt DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래제안 정보 조회 -->
    <select id="selectTradeSuggest" resultType="com.moira.itda.domain.chat.dto.response.ChatRoomResponse">
        SELECT
               CR.id                            AS chat_room_id
             , CR.status                        AS chat_room_status
             , CR.trade_id
             , CR.trade_item_id
             , T.gacha_id
             , T.status                         AS trade_status
             , T.type                           AS trade_type
             , T.title                          AS trade_title
             , CR.seller_id
             , U_S.nickname                     AS seller_nickname
             , CR.buyer_id
             , U_B.nickname                     AS buyer_nickname
             , CR.trade_suggest_id              AS suggest_id
             , TS.status                        AS suggest_status
             , TS.purchase_item_id
             , GI_P.name                        AS purchase_item_name
             , TS.purchase_count
             , CASE WHEN TS.purchase_discount_yn = 'Y'
                    THEN TS.purchase_discount_price
                    ELSE TS.purchase_original_price
               END                              AS purchase_price
             , TS.exchange_seller_item_id
             , GI_E1.name                       AS exchange_seller_item_name
             , TS.exchange_suggested_item_id
             , GI_E2.name                       AS exchange_suggested_item_name
        FROM CHAT_ROOM CR
        INNER JOIN TRADE        T     ON T.id     = CR.trade_id
        INNER JOIN USER         U_S   ON U_S.id   = CR.seller_id
        INNER JOIN USER         U_B   ON U_B.id   = CR.buyer_id
        LEFT JOIN TRADE_SUGGEST TS    ON TS.id    = CR.trade_suggest_id
        LEFT JOIN GACHA_ITEM    GI_P  ON GI_P.id  = TS.purchase_item_id
        LEFT JOIN GACHA_ITEM    GI_E1 ON GI_E1.id = TS.exchange_seller_item_id
        LEFT JOIN GACHA_ITEM    GI_E2 ON GI_E2.id = TS.exchange_suggested_item_id
        WHERE CR.id = #{chatRoomId}
    </select>

    <!-- 내 활동 > 채팅 > 채팅방 > 이전 채팅 목록 조회 -->
    <select id="selectChatMessageList" resultType="com.moira.itda.domain.chat.dto.response.ChatMessageResponse">
        SELECT
               CM.id      AS chatMessageId
             , CM.sender_id
             , U.nickname AS senderNickname
             , CM.message
             , CM.created_at
        FROM CHAT_MESSAGE CM
         LEFT JOIN USER U ON U.id = CM.sender_id
        WHERE CM.chat_room_id = #{chatRoomId}
        ORDER BY CM.created_at ASC
    </select>

    <!-- 내 활동 > 채팅 > 채팅방 > 메시지 전송 > ChatMessage 저장 -->
    <insert id="insertChatMessage">
        INSERT INTO CHAT_MESSAGE (
               chat_room_id
             , sender_id
             , message
             , created_at
        )
        VALUES (
               #{chatRoomId}
             , #{senderId}
             , #{message}
             , #{createdAt}
        )
    </insert>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래취소 > 채팅방 정보 조회 -->
    <select id="selectChatInfo" resultType="java.util.HashMap">
        SELECT status, seller_id, buyer_id FROM CHAT_ROOM WHERE id = #{chatRoomId}
    </select>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > TradeCompleteHistory 저장 -->
    <insert id="insertTradeCompleteHistory">
        INSERT INTO TRADE_COMPLETE_HISTORY (
               chat_room_id
             , trade_id
             , trade_suggest_id
             , gacha_id
             , seller_id
             , buyer_id
             , completed_at
        )
        VALUES (
               #{chatRoomId}
             , #{tradeId}
             , #{tradeSuggestId}
             , #{gachaId}
             , #{sellerId}
             , #{buyerId}
             , #{completedAt}
        )
    </insert>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > ChatRoom status 변경 (ENDED) -->
    <update id="updateChatRoomStatusEnded">
        UPDATE CHAT_ROOM SET status = 'ENDED' WHERE id = #{chatRoomId}
    </update>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > TradeSuggest status 변경 (COMPLETED) -->
    <update id="updateTradeSuggestStatusCompleted">
        UPDATE TRADE_SUGGEST
        SET
               status     = 'COMPLETED'
             , updated_at = CURRENT_TIMESTAMP
        WHERE id = #{tradeSuggestId}
    </update>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > 나머지 TradeSuggest의 status 변경 (REJECTED) -->
    <update id="updateRestTradeSuggestStatusRejected">
        UPDATE TRADE_SUGGEST
        SET
               status     = 'REJECTED'
             , updated_at = CURRENT_TIMESTAMP
        WHERE trade_item_id = #{tradeItemId}
         AND  id           != #{tradeSuggestId}
    </update>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > TradeItem status 변경 (COMPLETED) -->
    <update id="updateTradeItemStatusCompleted">
        UPDATE TRADE_ITEM
        SET
               status     = 'COMPLETED'
             , updated_at = CURRENT_TIMESTAMP
        WHERE id = #{tradeItemId}
    </update>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > Trade 하위에 status가 PENDING인 TradeItem 존재 여부 확인 -->
    <select id="selectTradeItemStatusPendingChk">
        SELECT EXISTS (
            SELECT 1 FROM TRADE_ITEM
            WHERE trade_id = #{tradeId}
             AND  status   = 'PENDING'
        )
    </select>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > Trade status 변경 (COMPLETED) -->
    <update id="updateTradeStatusCompleted">
        UPDATE TRADE
        SET
               status     = 'COMPLETED'
             , updated_at = CURRENT_TIMESTAMP
        WHERE id = #{tradeId}
    </update>
</mapper>