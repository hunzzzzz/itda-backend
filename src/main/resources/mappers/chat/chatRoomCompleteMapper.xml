<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moira.itda.domain.chat.complete.mapper.ChatRoomCompleteMapper">
    <!-- 거래취소 > 채팅방 정보 조회 -->
    <select id="selectChatRoomInfo" resultType="java.util.HashMap">
        SELECT status, seller_id, buyer_id FROM CHAT_ROOM WHERE id = #{chatRoomId}
    </select>

    <!-- 거래완료 > ChatRoom의 status 변경 (ENDED) -->
    <update id="updateChatRoomStatusEnded">
        UPDATE CHAT_ROOM SET status = 'ENDED' WHERE id = #{chatRoomId}
    </update>

    <!-- 거래완료 > TradeCompleteHistory 저장 -->
    <insert id="insertTradeCompleteHistory">
        INSERT INTO TRADE_COMPLETE_HISTORY (
               chat_room_id
             , trade_id
             , trade_item_id
             , trade_suggest_id
             , gacha_id
             , seller_id
             , buyer_id
             , completed_at
        )
        VALUES (
               #{chatRoomId}
             , #{tradeId}
             , #{tradeItemId}
             , #{tradeSuggestId}
             , #{gachaId}
             , #{sellerId}
             , #{buyerId}
             , #{completedAt}
        )
    </insert>

    <!-- 거래완료 > TradeSuggest의 status 변경 (COMPLETED) -->
    <update id="updateTradeSuggestStatusCompleted">
        UPDATE TRADE_SUGGEST
        SET
               status     = 'COMPLETED'
             , updated_at = CURRENT_TIMESTAMP
        WHERE id = #{tradeSuggestId}
    </update>

    <!-- 거래완료 > 나머지 TradeSuggest 목록 조회 -->
    <select id="selectRestTradeSuggestList" resultType="java.util.HashMap">
        SELECT
               TS.id          AS suggest_id
             , TS.status      AS status
             , CR.id          AS chat_room_id
             , TS.trade_id    AS trade_id
             , TS.gacha_id    AS gacha_id
        FROM TRADE_SUGGEST TS
         INNER JOIN CHAT_ROOM CR ON CR.trade_item_id = TS.id
        WHERE TS.trade_item_id = #{tradeItemId}
         AND  TS.status       IN ('PENDING', 'APPROVED')
         AND  TS.id           != #{completedSuggestId}
    </select>

    <!-- 거래완료 > TradeItem의 status 변경 (COMPLETED) -->
    <update id="updateTradeItemStatusCompleted">
        UPDATE TRADE_ITEM
        SET
               status     = 'COMPLETED'
             , updated_at = CURRENT_TIMESTAMP
        WHERE id = #{tradeItemId}
    </update>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > Trade 하위에 status가 PENDING인 TradeItem 존재 여부 확인 -->
    <select id="selectTradeItemStatusPendingChk">
        SELECT EXISTS (
            SELECT 1 FROM TRADE_ITEM
            WHERE trade_id = #{tradeId}
             AND  status   = 'PENDING'
        )
    </select>

    <!-- 내 활동 > 채팅 > 채팅방 > 거래완료 > Trade status 변경 (COMPLETED) -->
    <update id="updateTradeStatusCompleted">
        UPDATE TRADE
        SET
               status     = 'COMPLETED'
             , updated_at = CURRENT_TIMESTAMP
        WHERE id = #{tradeId}
    </update>
</mapper>